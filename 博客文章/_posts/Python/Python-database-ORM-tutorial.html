<!DOCTYPE HTML>
<html lang="cn" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Python-database-ORM-tutorial - WhaleFall Obsidian Notes</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="Keep Notes everyday">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../index.html"><strong aria-hidden="true">1.</strong> 落落的Notes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../2023-09-19.html"><strong aria-hidden="true">1.1.</strong> 2023-09-19</a></li><li class="chapter-item expanded "><a href="../../../SUMMARY.html"><strong aria-hidden="true">1.2.</strong> SUMMARY</a></li><li class="chapter-item expanded "><a href="../../../业余无线电Ham/index.html"><strong aria-hidden="true">1.3.</strong> 业余无线电Ham</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../业余无线电Ham/业余无线电采购.html"><strong aria-hidden="true">1.3.1.</strong> 业余无线电采购</a></li><li class="chapter-item expanded "><a href="../../../业余无线电Ham/广播.html"><strong aria-hidden="true">1.3.2.</strong> 广播</a></li><li class="chapter-item expanded "><a href="../../../业余无线电Ham/业余无线电笔记.html"><strong aria-hidden="true">1.3.3.</strong> 业余无线电笔记</a></li><li class="chapter-item expanded "><a href="../../../业余无线电Ham/通联日志.html"><strong aria-hidden="true">1.3.4.</strong> 通联日志</a></li><li class="chapter-item expanded "><a href="../../../业余无线电Ham/泉盛-K5-音质优化.html"><strong aria-hidden="true">1.3.5.</strong> 泉盛-K5-音质优化</a></li><li class="chapter-item expanded "><a href="../../../业余无线电Ham/附近航空频率.html"><strong aria-hidden="true">1.3.6.</strong> 附近航空频率</a></li><li class="chapter-item expanded "><a href="../../../业余无线电Ham/Opengd77-Firmware-教程.html"><strong aria-hidden="true">1.3.7.</strong> Opengd77-Firmware-教程</a></li><li class="chapter-item expanded "><a href="../../../业余无线电Ham/广播/index.html"><strong aria-hidden="true">1.3.8.</strong> 广播</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../业余无线电Ham/广播/广播收听报告-2023.05.23.html"><strong aria-hidden="true">1.3.8.1.</strong> 广播收听报告-2023.05.23</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../碎碎念/index.html"><strong aria-hidden="true">1.4.</strong> 碎碎念</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../碎碎念/记录.html"><strong aria-hidden="true">1.4.1.</strong> 记录</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/freedom.html"><strong aria-hidden="true">1.4.2.</strong> freedom</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/《勇抓机遇，铸就成功》.html"><strong aria-hidden="true">1.4.3.</strong> 《勇抓机遇，铸就成功》</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/福芝talk.html"><strong aria-hidden="true">1.4.4.</strong> 福芝talk</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/文案.html"><strong aria-hidden="true">1.4.5.</strong> 文案</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/手机卡分销.html"><strong aria-hidden="true">1.4.6.</strong> 手机卡分销</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/知乎精选.html"><strong aria-hidden="true">1.4.7.</strong> 知乎精选</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/思源笔记本使用感想.html"><strong aria-hidden="true">1.4.8.</strong> 思源笔记本使用感想</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/猫猫.html"><strong aria-hidden="true">1.4.9.</strong> 猫猫</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/手机卡分销类型.html"><strong aria-hidden="true">1.4.10.</strong> 手机卡分销类型</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/闲鱼文案模板.html"><strong aria-hidden="true">1.4.11.</strong> 闲鱼文案模板</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/online-class.html"><strong aria-hidden="true">1.4.12.</strong> online-class</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/奇思妙想.html"><strong aria-hidden="true">1.4.13.</strong> 奇思妙想</a></li><li class="chapter-item expanded "><a href="../../../碎碎念/猫猫/index.html"><strong aria-hidden="true">1.4.14.</strong> 猫猫</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../碎碎念/猫猫/多多.html"><strong aria-hidden="true">1.4.14.1.</strong> 多多</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../CutBoard/index.html"><strong aria-hidden="true">1.5.</strong> CutBoard</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../CutBoard/无线电爬取脚本.html"><strong aria-hidden="true">1.5.1.</strong> 无线电爬取脚本</a></li></ol></li><li class="chapter-item expanded "><a href="../../../other/index.html"><strong aria-hidden="true">1.6.</strong> other</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../other/OPENAI-KEY.html"><strong aria-hidden="true">1.6.1.</strong> OPENAI-KEY</a></li><li class="chapter-item expanded "><a href="../../../other/未命名.html"><strong aria-hidden="true">1.6.2.</strong> 未命名</a></li><li class="chapter-item expanded "><a href="../../../other/写给v友的一段话.html"><strong aria-hidden="true">1.6.3.</strong> 写给v友的一段话</a></li><li class="chapter-item expanded "><a href="../../../other/模拟飞行.html"><strong aria-hidden="true">1.6.4.</strong> 模拟飞行</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Study/index.html"><strong aria-hidden="true">1.7.</strong> Study</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Study/Physical/index.html"><strong aria-hidden="true">1.7.1.</strong> Physical</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Study/Physical/第六讲.html"><strong aria-hidden="true">1.7.1.1.</strong> 第六讲</a></li><li class="chapter-item expanded "><a href="../../../Study/Physical/第一讲-运动的描述.html"><strong aria-hidden="true">1.7.1.2.</strong> 第一讲-运动的描述</a></li><li class="chapter-item expanded "><a href="../../../Study/Physical/第二讲-比例问题.html"><strong aria-hidden="true">1.7.1.3.</strong> 第二讲-比例问题</a></li><li class="chapter-item expanded "><a href="../../../Study/Physical/第7讲.html"><strong aria-hidden="true">1.7.1.4.</strong> 第7讲</a></li><li class="chapter-item expanded "><a href="../../../Study/Physical/第5讲-力的正交分解.html"><strong aria-hidden="true">1.7.1.5.</strong> 第5讲-力的正交分解</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Study/Chemistry/index.html"><strong aria-hidden="true">1.7.2.</strong> Chemistry</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Study/Chemistry/第一讲-离子反应的基础概念.html"><strong aria-hidden="true">1.7.2.1.</strong> 第一讲-离子反应的基础概念</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Study/Math/index.html"><strong aria-hidden="true">1.7.3.</strong> Math</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Study/Math/函数.html"><strong aria-hidden="true">1.7.3.1.</strong> 函数</a></li><li class="chapter-item expanded "><a href="../../../Study/Math/第一讲-集合与常用逻辑用语.html"><strong aria-hidden="true">1.7.3.2.</strong> 第一讲-集合与常用逻辑用语</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../test/index.html"><strong aria-hidden="true">1.8.</strong> test</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../test/Obsidian-Hexo-模板测试.html"><strong aria-hidden="true">1.8.1.</strong> Obsidian-Hexo-模板测试</a></li><li class="chapter-item expanded "><a href="../../../test/落落-OpenWRT-导航页.html"><strong aria-hidden="true">1.8.2.</strong> 落落-OpenWRT-导航页</a></li><li class="chapter-item expanded "><a href="../../../test/思源笔记自动同步测试.html"><strong aria-hidden="true">1.8.3.</strong> 思源笔记自动同步测试</a></li></ol></li><li class="chapter-item expanded "><a href="../../../English-Study/index.html"><strong aria-hidden="true">1.9.</strong> English-Study</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../English-Study/英语音标学习.html"><strong aria-hidden="true">1.9.1.</strong> 英语音标学习</a></li></ol></li><li class="chapter-item expanded "><a href="../../../高中事件/index.html"><strong aria-hidden="true">1.10.</strong> 高中事件</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../高中事件/举报信.html"><strong aria-hidden="true">1.10.1.</strong> 举报信</a></li><li class="chapter-item expanded "><a href="../../../高中事件/举报中小学教师违规方法论.html"><strong aria-hidden="true">1.10.2.</strong> 举报中小学教师违规方法论</a></li><li class="chapter-item expanded "><a href="../../../高中事件/举报法律依据.html"><strong aria-hidden="true">1.10.3.</strong> 举报法律依据</a></li></ol></li><li class="chapter-item expanded "><a href="../../../博客文章/index.html"><strong aria-hidden="true">1.11.</strong> 博客文章</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../博客文章/博客文章测试.html"><strong aria-hidden="true">1.11.1.</strong> 博客文章测试</a></li><li class="chapter-item expanded "><a href="../../../博客文章/博客文章_post.html"><strong aria-hidden="true">1.11.2.</strong> 博客文章_post</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/index.html"><strong aria-hidden="true">1.11.3.</strong> _posts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Rpi-1.html"><strong aria-hidden="true">1.11.3.1.</strong> Rpi-1</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Rortos-Flight-Simulation-Tutorial.html"><strong aria-hidden="true">1.11.3.2.</strong> Rortos-Flight-Simulation-Tutorial</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/openwebrx-sdr.html"><strong aria-hidden="true">1.11.3.3.</strong> openwebrx-sdr</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Freedom-network.html"><strong aria-hidden="true">1.11.3.4.</strong> Freedom-network</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Samba4-config.html"><strong aria-hidden="true">1.11.3.5.</strong> Samba4-config</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/vscode-shortcut-key.html"><strong aria-hidden="true">1.11.3.6.</strong> vscode-shortcut-key</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Rpi-2.html"><strong aria-hidden="true">1.11.3.7.</strong> Rpi-2</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/onedrive-guide.html"><strong aria-hidden="true">1.11.3.8.</strong> onedrive-guide</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Github-workflow.html"><strong aria-hidden="true">1.11.3.9.</strong> Github-workflow</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/China-Documentary.html"><strong aria-hidden="true">1.11.3.10.</strong> China-Documentary</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/how-to-ues-free-ChatGPT-in-China.html"><strong aria-hidden="true">1.11.3.11.</strong> how-to-ues-free-ChatGPT-in-China</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Vim-config.html"><strong aria-hidden="true">1.11.3.12.</strong> Vim-config</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Hexo-blog-format.html"><strong aria-hidden="true">1.11.3.13.</strong> Hexo-blog-format</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/cpp-guide-book.html"><strong aria-hidden="true">1.11.3.14.</strong> cpp-guide-book</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Linux-note.html"><strong aria-hidden="true">1.11.3.15.</strong> Linux-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Kali-Linux-Help.html"><strong aria-hidden="true">1.11.3.16.</strong> Kali-Linux-Help</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Rpi-3.html"><strong aria-hidden="true">1.11.3.17.</strong> Rpi-3</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Wky-help.html"><strong aria-hidden="true">1.11.3.18.</strong> Wky-help</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Depression-medicine.html"><strong aria-hidden="true">1.11.3.19.</strong> Depression-medicine</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/clash-proxy-tutorial.html"><strong aria-hidden="true">1.11.3.20.</strong> clash-proxy-tutorial</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Linux-iptables.html"><strong aria-hidden="true">1.11.3.21.</strong> Linux-iptables</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/openwrt-lede-build-notes.html"><strong aria-hidden="true">1.11.3.22.</strong> openwrt-lede-build-notes</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Server-all.html"><strong aria-hidden="true">1.11.3.23.</strong> Server-all</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/radio-SWshort.html"><strong aria-hidden="true">1.11.3.24.</strong> radio-SWshort</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/index.html"><strong aria-hidden="true">1.11.3.25.</strong> Python</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/Python-async.html"><strong aria-hidden="true">1.11.3.25.1.</strong> Python-async</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/Python-Concurrent.html"><strong aria-hidden="true">1.11.3.25.2.</strong> Python-Concurrent</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/Python-Generator-Iterator-decorater.html"><strong aria-hidden="true">1.11.3.25.3.</strong> Python-Generator-Iterator-decorater</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/Python-database-ORM-tutorial.html" class="active"><strong aria-hidden="true">1.11.3.25.4.</strong> Python-database-ORM-tutorial</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/Python-Tkinter-GUI.html"><strong aria-hidden="true">1.11.3.25.5.</strong> Python-Tkinter-GUI</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/python-black-magic.html"><strong aria-hidden="true">1.11.3.25.6.</strong> python-black-magic</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/Python-pydantic-tutorial.html"><strong aria-hidden="true">1.11.3.25.7.</strong> Python-pydantic-tutorial</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Python/Flask-Web-note.html"><strong aria-hidden="true">1.11.3.25.8.</strong> Flask-Web-note</a></li></ol></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/index.html"><strong aria-hidden="true">1.11.3.26.</strong> Golang</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-package-note.html"><strong aria-hidden="true">1.11.3.26.1.</strong> Golang-package-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-method-note.html"><strong aria-hidden="true">1.11.3.26.2.</strong> Golang-method-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-interface-note.html"><strong aria-hidden="true">1.11.3.26.3.</strong> Golang-interface-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-function-note.html"><strong aria-hidden="true">1.11.3.26.4.</strong> Golang-function-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-JSON-note.html"><strong aria-hidden="true">1.11.3.26.5.</strong> Golang-JSON-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-envbuild-note.html"><strong aria-hidden="true">1.11.3.26.6.</strong> Golang-envbuild-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-struct-note.html"><strong aria-hidden="true">1.11.3.26.7.</strong> Golang-struct-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-pointer-note.html"><strong aria-hidden="true">1.11.3.26.8.</strong> Golang-pointer-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-error-note.html"><strong aria-hidden="true">1.11.3.26.9.</strong> Golang-error-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-project-and-gomod-note.html"><strong aria-hidden="true">1.11.3.26.10.</strong> Golang-project-and-gomod-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-variable-note.html"><strong aria-hidden="true">1.11.3.26.11.</strong> Golang-variable-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-map-note.html"><strong aria-hidden="true">1.11.3.26.12.</strong> Golang-map-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-const-note.html"><strong aria-hidden="true">1.11.3.26.13.</strong> Golang-const-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-type-keyword-note.html"><strong aria-hidden="true">1.11.3.26.14.</strong> Golang-type-keyword-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-goruntine-note.html"><strong aria-hidden="true">1.11.3.26.15.</strong> Golang-goruntine-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-datatype-note.html"><strong aria-hidden="true">1.11.3.26.16.</strong> Golang-datatype-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-id-note.html"><strong aria-hidden="true">1.11.3.26.17.</strong> Golang-id-note</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-note-catalogue.html"><strong aria-hidden="true">1.11.3.26.18.</strong> Golang-note-catalogue</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Golang/Golang-HTML-note.html"><strong aria-hidden="true">1.11.3.26.19.</strong> Golang-HTML-note</a></li></ol></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/JavaScript/index.html"><strong aria-hidden="true">1.11.3.27.</strong> JavaScript</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../博客文章/_posts/JavaScript/vue-tutorial.html"><strong aria-hidden="true">1.11.3.27.1.</strong> vue-tutorial</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/JavaScript/JavaScript-fast-start.html"><strong aria-hidden="true">1.11.3.27.2.</strong> JavaScript-fast-start</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/JavaScript/nodejs-fast-start.html"><strong aria-hidden="true">1.11.3.27.3.</strong> nodejs-fast-start</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/JavaScript/TypeScript-fast-start.html"><strong aria-hidden="true">1.11.3.27.4.</strong> TypeScript-fast-start</a></li></ol></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Study/index.html"><strong aria-hidden="true">1.11.3.28.</strong> Study</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Study/Zhongkao-maths.html"><strong aria-hidden="true">1.11.3.28.1.</strong> Zhongkao-maths</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Study/Ancient-poems.html"><strong aria-hidden="true">1.11.3.28.2.</strong> Ancient-poems</a></li><li class="chapter-item expanded "><a href="../../../博客文章/_posts/Study/GK-study-tutorial.html"><strong aria-hidden="true">1.11.3.28.3.</strong> GK-study-tutorial</a></li></ol></li></ol></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">WhaleFall Obsidian Notes</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<p>title: Python database 数据库 ORM 框架
date: 2023-09-09 08:12:64
updated: 2023-09-09 08:12:64
categories: Python
tags:</p>
<ul>
<li>databases</li>
<li>python</li>
<li>ORM</li>
<li>mysql
description: 
thumbnail: 
banner_img:</li>
</ul>
<hr />
<h1 id="python-database-数据库-orm-框架"><a class="header" href="#python-database-数据库-orm-框架">Python database 数据库 ORM 框架</a></h1>
<p><strong>ORM</strong> (<strong>O</strong>object <strong>R</strong>elational <strong>M</strong>apper) 对象关系映射，用于在 Code 中通过 Object 来操作<strong>关系型数据库</strong>，将用户定义的 Python 类映射到数据库表和其他构造 ，而不用直接手撕 SQL 语句。增加安全性和可维护性。</p>
<p>SQLAlchemy （SQL 炼金术 <code>/ˈæl.kə.mi/</code> ）是 Python 中用于操作各种 <strong>关系型数据库</strong> 的 <strong>ORM</strong></p>
<p><a href="https://yifei.me/note/2652">SQLAlchemy 2.0 教程 - Yifei's Notes</a></p>
<p><a href="https://docs.sqlalchemy.org/en/20/intro.html">SQLAlchemy Offical Tutorial</a></p>
<p><img src="http://oss.whaleluo.top/blog/img/Python-database-ORM-tutorial-components.png-picsmall" alt="" /></p>
<p>SQLAlchemy 包含 对象关系映射器 <strong>ORM</strong> 和 核心 <strong>Core</strong> 两部分 API，ORM 构建于 Core 之上，如上图。<strong>DBAPI</strong> 代表底层数据库的驱动，例如：<code>pymysql</code> <code>sqlite3</code> 与特定数据库交互的第三方驱动程序。</p>
<h2 id="install"><a class="header" href="#install">Install</a></h2>
<pre><code class="language-shell">pip install SQLAlchemy
</code></pre>
<h2 id="establish-connectivity-建立链接"><a class="header" href="#establish-connectivity-建立链接">Establish Connectivity 建立链接</a></h2>
<p><code>Engine</code> 对象通过 <code>create_engine()</code> 方法来构造，是只用创建一次的全局对象。<br />
<code>create_engine()</code> 首次返回不会链接到数据库，仅在调用 Engine 对象执行数据库操作时才链接到数据库 （被称为 <strong>Lazy loading</strong> 的设计模式），<a href="https://docs.sqlalchemy.org/en/20/glossary.html#term-lazy-initialization">lazy initialization</a></p>
<pre><code class="language-python">from sqlalchemy import create_engine
engine = create_engine(&quot;sqlite+pysqlite:///:memory:&quot;, echo=True)
</code></pre>
<h3 id="connect-mysql-server"><a class="header" href="#connect-mysql-server">Connect mysql server</a></h3>
<p>reference: <a href="https://docs.sqlalchemy.org/en/20/dialects/mysql.html">MySQL and MariaDB — SQLAlchemy 2.0 Documentation</a></p>
<h2 id="transactions-事务操作"><a class="header" href="#transactions-事务操作">Transactions 事务操作</a></h2>
<h3 id="core-engine-connect"><a class="header" href="#core-engine-connect">Core Engine Connect</a></h3>
<pre><code class="language-python">from sqlalchemy import text

# 获取数据库游标
with engine.connect() as conn:
	
	# 返回 Result 对象	
    result = conn.execute(text(&quot;select 'hello world'&quot;))
    print(result.all())
    
    # 提交变更
    conn.commit()
	result = conn.execute(text(&quot;SELECT x, y FROM some_table&quot;))
	for row in result:
		print(f&quot;x: {row.x}  y: {row.y}&quot;)
	
	# 带参数的 sql 语句拼接
    result = conn.execute(text(&quot;SELECT x, y FROM some_table WHERE y &gt; :y&quot;), {&quot;y&quot;: 2})
    for row in result:
        print(f&quot;x: {row.x}  y: {row.y}&quot;)

	# 多参数 executemany
	conn.execute(
         text(&quot;INSERT INTO some_table (x, y) VALUES (:x, :y)&quot;),
         [{&quot;x&quot;: 11, &quot;y&quot;: 12}, {&quot;x&quot;: 13, &quot;y&quot;: 14}],
     )

</code></pre>
<h3 id="orm-engine-session"><a class="header" href="#orm-engine-session">ORM Engine Session</a></h3>
<p>使用 ORM 时的基本事务/数据库交互对象称为 <code>Session</code>。<br />
<code>Session</code> 在结束事务后实际上并不保留 <code>Connection</code> 对象。下次需要对数据库执行 SQL 时，它会从 <code>Engine</code> 获取新的 <code>Connection</code> 。</p>
<pre><code class="language-python">from sqlalchemy.orm import Session

stmt = text(&quot;SELECT x, y FROM some_table WHERE y &gt; :y ORDER BY x, y&quot;)
with Session(engine) as session:
    result = session.execute(stmt, {&quot;y&quot;: 6})
    for row in result:
        print(f&quot;x: {row.x}  y: {row.y}&quot;)
    
    result = session.execute(
         text(&quot;UPDATE some_table SET y=:y WHERE x=:x&quot;),
        [{&quot;x&quot;: 9, &quot;y&quot;: 11}, {&quot;x&quot;: 13, &quot;y&quot;: 15}],
   )
    session.commit()
</code></pre>
<p>通过 with 语句构建 begin 开始、rollback 回滚、commit 提交 语句。</p>
<pre><code class="language-python"># verbose version of what a context manager will do
with Session(engine) as session:
    # session.begin() auto commit database
    # create session and add objects
	with session.begin():
		session.add(some_object)
        session.add(some_other_object)
	    # inner context calls session.commit(), if there were no exceptions
		# outer context calls session.close()
    try:
        session.add(some_object)
        session.add(some_other_object)
    except:
        session.rollback()
        raise
    else:
        session.commit()
</code></pre>
<p>更简洁的实现：</p>
<pre><code class="language-python"># create session and add objects
with Session(engine) as session, session.begin():
    session.add(some_object)
    session.add(some_other_object)
	# inner context calls session.commit(), if there were no exceptions
	# outer context calls session.close()
</code></pre>
<p>或者使用 session macker(会话生成器)：</p>
<pre><code class="language-python">from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# an Engine, which the Session will use for connection
# resources
engine = create_engine(&quot;postgresql+psycopg2://scott:tiger@localhost/&quot;)

# a sessionmaker(), also in the same scope as the engine
Session = sessionmaker(engine)

# we can now construct a Session() and include begin()/commit()/rollback()
# at once
with Session.begin() as session:
    session.add(some_object)
    session.add(some_other_object)
	# commits the transaction, closes the session
</code></pre>
<h2 id="database-metadata-数据库元数据-orm"><a class="header" href="#database-metadata-数据库元数据-orm">Database Metadata 数据库元数据 ORM</a></h2>
<p>SQLAlchemy 中数据库元数据最常见的基础对象称为 <code>MetaData</code> 、 <code>Table</code> 和 <code>Column</code>。<br />
一种创建表的方式是 <strong>显性使用 MetaData</strong> 表集合来创建：</p>
<pre><code class="language-python">from sqlalchemy import Table, Column, Integer, String
# `MetaData` 对象是表的集合
from sqlalchemy import MetaData
metadata_obj = MetaData()

# 用户表
user_table = Table(
    &quot;user_account&quot;,
    metadata_obj,
    Column(&quot;id&quot;, Integer, primary_key=True),
    Column(&quot;name&quot;, String(30)),
    Column(&quot;fullname&quot;, String),
)

# 新建表
metadata_obj.create_all(engine)
</code></pre>
<h3 id="declarative-base-声明式基础"><a class="header" href="#declarative-base-声明式基础">Declarative base 声明式基础</a></h3>
<p>一种是使用 <strong>对象</strong> 的方式来创建表。</p>
<pre><code class="language-python">from sqlalchemy.orm import DeclarativeBase
# 创建一个 DeclarativeBase 的子类 Base
# 可以基于这个子类 Base 来映射 mapper 数据
# 构造声明性类定义的基类 相当于已经弃用的 Base = declarative_base()
class Base(DeclarativeBase):
    pass

# 建立 `Base` 类后，可以基于 Base 类 定义 ORM 映射类
from typing import List
from typing import Optional
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship

# ORM 映射类
class User(Base):
    __tablename__ = &quot;user_account&quot;
    # 为了指示 `Table` 中的列，使用 `mapped_column()` 构造，并结合基于 `Mapped` 类型的键入注释。该对象将生成应用于 `Table` 构造的 `Column` 对象。
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(30))
    
	# 对于具有简单数据类型且没有其他选项的列，我们可以单独指示 `Mapped` 类型注释，使用简单的 Python 类型
    fullname: Mapped[Optional[str]]
    addresses: Mapped[List[&quot;Address&quot;]] = relationship(back_populates=&quot;user&quot;)
	
	# 获得可读的字符串输出
    def __repr__(self) -&gt; str:
        return f&quot;User(id={self.id!r}, name={self.name!r}, fullname={self.fullname!r})&quot;

class Address(Base):
    __tablename__ = &quot;address&quot;
    id: Mapped[int] = mapped_column(primary_key=True)
    email_address: Mapped[str]
    user_id = mapped_column(ForeignKey(&quot;user_account.id&quot;))
    user: Mapped[User] = relationship(back_populates=&quot;addresses&quot;)
    def __repr__(self) -&gt; str:
        return f&quot;Address(id={self.id!r}, email_address={self.email_address!r})&quot;

# 向数据库构建表
# 运行 PRAGMA 语句，但不会生成新表，因为发现它们已经存在
Base.metadata.create_all(engine)

</code></pre>
<h3 id="table-reflection-表反射"><a class="header" href="#table-reflection-表反射">Table Reflection 表反射</a></h3>
<p>用于识别已有数据库的映射。</p>
<pre><code class="language-python"># `MetaData` 对象是表的集合,元数据
from sqlalchemy import MetaData
metadata_obj = MetaData()
# 将创建一个新的 `Table` 对象 自动识别
some_table = Table(&quot;some_table&quot;, metadata_obj, autoload_with=engine)
</code></pre>
<h2 id="working-with-data-处理数据"><a class="header" href="#working-with-data-处理数据">Working with Data 处理数据</a></h2>
<h3 id="working-with-sql-core-拼接构造-sql-语句"><a class="header" href="#working-with-sql-core-拼接构造-sql-语句">Working with sql core 拼接构造 sql 语句</a></h3>
<p>reference: <a href="https://docs.sqlalchemy.org/en/20/tutorial/data_select.html">Using SELECT Statements — SQLAlchemy 2.0 Documentation</a></p>
<h4 id="insert-插入"><a class="header" href="#insert-插入">Insert 插入</a></h4>
<pre><code class="language-python">with engine.connect() as conn:
	# insert(user_table).values(name=&quot;spongebob&quot;, fullname=&quot;Spongebob Squarepants&quot;)
    result = conn.execute(
        insert(user_table),
        [
            {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;},
            {&quot;name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},
        ],
    )
    conn.commit()
</code></pre>
<h4 id="select-选择查询"><a class="header" href="#select-选择查询">Select 选择查询</a></h4>
<pre><code class="language-python">from sqlalchemy import select
stmt = select(user_table).where(user_table.c.name == &quot;spongebob&quot;)
print(stmt) # 生成一段 mysql 语句
# SELECT user_account.id, user_account.name, user_account.fullname FROM user_account WHERE user_account.name = :name_1

# first() 第一个数据
row = session.execute(select(User)).first()

# all() 全部数据
session.execute(
				select(User.name, Address).where(User.id == Address.user_id).order_by(Address.id)
			).all()

# where 语句 c: column
user_table.c.name == &quot;squidward&quot;
select(user_table).where(user_table.c.name == &quot;squidward&quot;)

# 多查
print(
    select(address_table.c.email_address)
    .where(user_table.c.name == &quot;squidward&quot;)
    .where(address_table.c.user_id == user_table.c.id)
)
print(
    select(address_table.c.email_address).where(
        user_table.c.name == &quot;squidward&quot;,
        address_table.c.user_id == user_table.c.id,
    )
)

# AND OR 语句
from sqlalchemy import and_, or_
print(
    select(Address.email_address).where(
        and_(
            or_(User.name == &quot;squidward&quot;, User.name == &quot;sandy&quot;),
            Address.user_id == User.id,
        )
    )
)

# ORDER BY 排序依据
print(select(user_table).order_by(user_table.c.name))
</code></pre>
<h4 id="update-更新"><a class="header" href="#update-更新">Update 更新</a></h4>
<pre><code class="language-python">from sqlalchemy import update
stmt = (
    update(user_table)
    .where(user_table.c.name == &quot;patrick&quot;)
    .values(fullname=&quot;Patrick the Star&quot;)
)
print(stmt)


with engine.begin() as conn:
    result = conn.execute(
        update(user_table)
        .values(fullname=&quot;Patrick McStar&quot;)
        .where(user_table.c.name == &quot;patrick&quot;)
    )
    print(result.rowcount)

update_stmt = (
    update(user_table)
    .where(user_table.c.name == &quot;patrick&quot;)
    .values(fullname=&quot;Patrick the Star&quot;)
    .returning(user_table.c.id, user_table.c.name) # 定义返回的数据
)


print(update_stmt)
delete_stmt = (
    delete(user_table)
    .where(user_table.c.name == &quot;patrick&quot;)
    .returning(user_table.c.id, user_table.c.name)
)
print(delete_stmt)
</code></pre>
<h4 id="delete-删除"><a class="header" href="#delete-删除">Delete 删除</a></h4>
<pre><code class="language-python">delete_stmt = (
    delete(user_table)
    .where(user_table.id == address_table.user_id)
    .where(address_table.email_address == &quot;patrick@aol.com&quot;)
)
</code></pre>
<h4 id="count-计数"><a class="header" href="#count-计数">Count 计数</a></h4>
<p><a href="https://stackoverflow.com/questions/12941416/how-to-count-rows-with-select-count-with-sqlalchemy/76155009#76155009?newreg=931f85ad102d493db5aaa753479640f9">python - How to count rows with SELECT COUNT(*) with SQLAlchemy? - Stack Overflow</a></p>
<pre><code class="language-python">from sqlalchemy import func, select

class MyModel(Base):
	...

statement = select(func.count()).select_from(MyModel)
count: int = session.execute(statement).scalar()
</code></pre>
<h3 id="woking-with-orm"><a class="header" href="#woking-with-orm">Woking with ORM</a></h3>
<p>Instances of Classes represent Rows 表类的实例代表行。</p>
<pre><code class="language-python">squidward = User(name=&quot;squidward&quot;, fullname=&quot;Squidward Tentacles&quot;)
krabs = User(name=&quot;ehkrabs&quot;, fullname=&quot;Eugene H. Krabs&quot;)
session = Session(engine)
session.add(squidward)
session.commit()
</code></pre>
<p>从主键获取对象：</p>
<pre><code class="language-python">some_squidward = session.get(User, 4) # 直接返回数据库对象类型
some_squidward = User(id=4, name='squidward', fullname='Squidward Tentacles')
</code></pre>
<p>从 execute 获取对象：<code>scalar()</code> scalar /ˈskeɪ.lər/</p>
<pre><code class="language-python">sandy = session.execute(select(User).filter_by(name=&quot;sandy&quot;)).scalar_one()

session.execute(
  select(User)
).scalars().all()

# or

session.scalars(
  select(User)
).all()
</code></pre>
<h2 id="asyncio-support"><a class="header" href="#asyncio-support">AsyncIO Support</a></h2>
<p>对异步 IO 的支持：<a href="https://docs.sqlalchemy.org/en/20/intro.html#asyncio-support">Overview — SQLAlchemy 2.0 Documentation</a></p>
<p>reference: <a href="https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html">Asynchronous I/O (asyncio) — SQLAlchemy 2.0 Documentation</a></p>
<p>install:</p>
<pre><code class="language-shell">pip install sqlalchemy[asyncio]
</code></pre>
<p>install Asynchronous DBAPI:</p>
<pre><code class="language-python">
# SQLTIE3 sqlite+aiosqlite:///database.db  # 数据库文件名为 database.db 不存在的新建一个
# 异步 mysql+aiomysql://user:password@host:port/dbname
DB_URL = &quot;mysql+aiomysql://root:123456@localhost:3306/tgconfigs&quot;
</code></pre>
<p>uses:</p>
<pre><code class="language-python">import asyncio

from sqlalchemy import Column
from sqlalchemy import MetaData
from sqlalchemy import select
from sqlalchemy import String
from sqlalchemy import Table
from sqlalchemy.ext.asyncio import create_async_engine

meta = MetaData()
t1 = Table(&quot;t1&quot;, meta, Column(&quot;name&quot;, String(50), primary_key=True))

class Base(AsyncAttrs, DeclarativeBase):
    pass

async def async_main() -&gt; None:
	# 创建异步数据库 engine
    engine = create_async_engine(
        &quot;postgresql+asyncpg://scott:tiger@localhost/test&quot;,
        echo=True,
    )

    async with engine.begin() as conn:
	    # `run_sync()` 方法可用于调用特殊的 DDL 函数，例如不包含可等待挂钩的 `MetaData.create_all()`
        await conn.run_sync(meta.create_all)

        await conn.execute(
            t1.insert(), [{&quot;name&quot;: &quot;some name 1&quot;}, {&quot;name&quot;: &quot;some name 2&quot;}]
        )

    async with engine.connect() as conn:
        # select a Result, which will be delivered with buffered
        # results
        result = await conn.execute(select(t1).where(t1.c.name == &quot;some name 1&quot;))

        print(result.fetchall())

    # for AsyncEngine created in function scope, close and
    # clean-up pooled connections
    # 当在超出上下文并被垃圾回收的作用域中使用 `AsyncEngine` 对象时，建议使用 `await` 调用 `AsyncEngine.dispose()` 方法，如上例中的 `async_main` 函数。这确保了连接池保持打开的任何连接都将在可等待上下文中得到正确处理。
    await engine.dispose()


asyncio.run(async_main())
</code></pre>
<h3 id="complete-example-完整示例"><a class="header" href="#complete-example-完整示例">Complete example 完整示例</a></h3>
<pre><code class="language-python">from __future__ import annotations

import asyncio
import datetime
from typing import List

from sqlalchemy import ForeignKey
from sqlalchemy import func
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncAttrs
from sqlalchemy.ext.asyncio import async_sessionmaker
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.ext.asyncio import create_async_engine
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship
from sqlalchemy.orm import selectinload


class Base(AsyncAttrs, DeclarativeBase):
    pass


class A(Base):
    __tablename__ = &quot;a&quot;

    id: Mapped[int] = mapped_column(primary_key=True)
    data: Mapped[str]
    create_date: Mapped[datetime.datetime] = mapped_column(server_default=func.now())
    bs: Mapped[List[B]] = relationship()


class B(Base):
    __tablename__ = &quot;b&quot;
    id: Mapped[int] = mapped_column(primary_key=True)
    a_id: Mapped[int] = mapped_column(ForeignKey(&quot;a.id&quot;))
    data: Mapped[str]

# 类型注释一个函数
async def insert_objects(async_session: async_sessionmaker[AsyncSession]) -&gt; None:
	# 使用 async session maker 构造 session
    async with async_session() as session:
        async with session.begin():
            session.add_all(
                [
                    A(bs=[B(), B()], data=&quot;a1&quot;),
                    A(bs=[], data=&quot;a2&quot;),
                    A(bs=[B(), B()], data=&quot;a3&quot;),
                ]
            )


async def select_and_update_objects(
    async_session: async_sessionmaker[AsyncSession],
) -&gt; None:
    async with async_session() as session:
        stmt = select(A).options(selectinload(A.bs))

        result = await session.execute(stmt)

        for a1 in result.scalars():
            print(a1)
            print(f&quot;created at: {a1.create_date}&quot;)
            for b1 in a1.bs:
                print(b1)

        result = await session.execute(select(A).order_by(A.id).limit(1))

        a1 = result.scalars().one()

        a1.data = &quot;new data&quot;

        await session.commit()

        # access attribute subsequent to commit; this is what
        # expire_on_commit=False allows
        print(a1.data)

        # alternatively, AsyncAttrs may be used to access any attribute
        # as an awaitable (new in 2.0.13)
        for b1 in await a1.awaitable_attrs.bs:
            print(b1)


async def async_main() -&gt; None:
    engine = create_async_engine(
        &quot;postgresql+asyncpg://scott:tiger@localhost/test&quot;,
        echo=True,
    )

    # async_sessionmaker: a factory for new AsyncSession objects.
    # expire_on_commit - don't expire objects after transaction commit
    async_session = async_sessionmaker(engine, expire_on_commit=False)

	# 异步使用同步方法
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

    await insert_objects(async_session)
    await select_and_update_objects(async_session)

    # for AsyncEngine created in function scope, close and
    # clean-up pooled connections
    await engine.dispose()


asyncio.run(async_main())
</code></pre>
<h2 id="legacy-query-api-旧版查询-api"><a class="header" href="#legacy-query-api-旧版查询-api">Legacy query API 旧版查询 API</a></h2>
<p><a href="https://docs.sqlalchemy.org/en/20/orm/queryguide/query.html#legacy-query-api">Legacy Query API — SQLAlchemy 2.0 Documentation</a></p>
<p>多年来，它是使用 SQLAlchemy ORM 时唯一的 SQL 接口。从版本 2.0 开始，一种全新的工作方式现已成为标准方法，其中适用于 Core 的相同 <code>select()</code> 构造也适用于 ORM，为构建查询提供一致的接口。</p>
<p>从旧版本迁移到 2.0 <a href="https://docs.sqlalchemy.org/en/20/changelog/migration_20.html#migration-20-query-usage">SQLAlchemy 2.0 - Major Migration Guide — SQLAlchemy 2.0 Documentation</a></p>
<p>SQLAlchemy 2.0 中最大的明显变化是使用 <code>Session.execute()</code> 与 <code>select()</code> 结合使用来运行 ORM 查询，而不是使用 <code>Session.query()</code> 。正如其他地方提到的，没有计划实际删除 <code>Session.query()</code> API 本身，因为它现在是通过在内部使用新 API 来实现的，它将保留为旧版 API，并且这两个 API 都可以自由使用。</p>
<h2 id="sqlalchemy-extansion-扩展"><a class="header" href="#sqlalchemy-extansion-扩展">SQLAlchemy Extansion 扩展</a></h2>
<h3 id="sqlalchemy-utils"><a class="header" href="#sqlalchemy-utils">Sqlalchemy-utils</a></h3>
<p>看样子比较老了。</p>
<p><a href="https://github.com/kvesteri/sqlalchemy-utils">GitHub - kvesteri/sqlalchemy-utils: Various utility functions and datatypes for SQLAlchemy.</a></p>
<blockquote>
<p>Various utility <strong>functions</strong> and <strong>datatypes</strong> for SQLAlchemy. SQLAlchemy 的各种实用函数和数据类型。</p>
</blockquote>
<h2 id="qa"><a class="header" href="#qa">Q&amp;A</a></h2>
<h3 id="is-the-session-thread-safe-线程安全-is-asyncsession-safe异步并发安全-to-share-in-concurrent-tasks"><a class="header" href="#is-the-session-thread-safe-线程安全-is-asyncsession-safe异步并发安全-to-share-in-concurrent-tasks">Is the Session thread-safe (线程安全)? Is AsyncSession safe(异步并发安全) to share in concurrent tasks?<a href="https://docs.sqlalchemy.org/en/20/orm/session_basics.html#is-the-session-thread-safe-is-asyncsession-safe-to-share-in-concurrent-tasks" title="Permalink to this heading">¶</a></a></h3>
<p><code>Session</code> 是一个可变的、有状态的对象，<code>session</code> 的实例就无法在并发线程或异步任务之间共享。 <code>Session</code> 旨在以非并发方式使用。</p>
<p>在设计并发数据库应用程序时，适当的模型是 <strong>每个并发任务/线程都处理自己的数据库事务 <code>Session</code></strong>。</p>
<p>确保这种使用的最佳方法是在线程或任务内部的顶级 Python 函数中本地使用 <strong>标准上下文管理器</strong> 模式。</p>
<h3 id="sqlalchemyexccompileerror-varcharvarchar-变长字符串-requires-a-length-on-dialect方言-mysql"><a class="header" href="#sqlalchemyexccompileerror-varcharvarchar-变长字符串-requires-a-length-on-dialect方言-mysql">sqlalchemy.exc.CompileError: VARCHAR(varchar 变长字符串) Requires a length on dialect(方言) mysql</a></h3>
<p><a href="https://stackoverflow.com/questions/16472725/invalidrequesterror-varchar-requires-a-length-on-dialect-mysql">python - InvalidRequestError: VARCHAR requires a length on dialect mysql - Stack Overflow</a></p>
<p>official docs: <a href="https://docs.sqlalchemy.org/en/20/orm/mapping_styles.html#imperative-mapping">ORM Mapped Class Overview — SQLAlchemy 2.0 Documentation</a></p>
<p>在 mysql 中使用 <strong>变长字符串</strong> 时需要使用 <code>String(100)</code> 来定义字符串长度：</p>
<pre><code class="language-python">class TGForwardConfig(Base):
    __tablename__ = 'forward_config'

    id: Mapped[int] = mapped_column(primary_key=True, doc=&quot;主键&quot;)
    source: Mapped[int] = mapped_column(doc=&quot;源群聊ID&quot;)
    dest: Mapped[int] = mapped_column(doc=&quot;目标群聊ID&quot;)
    forward_history_count: Mapped[int] = mapped_column(doc=&quot;转发历史信息的数量&quot;)
    interval_second: Mapped[int] = mapped_column(doc=&quot;间隔时间单位 s&quot;, default=20)

    remove_word: Mapped[Optional[str]] = mapped_column(
        String(100), doc=&quot;删除的文字,用,分隔&quot;, nullable=True)
    cut_word: Mapped[Optional[str]] = mapped_column(
        String(100), doc=&quot;截断词,用 , 分隔&quot;, nullable=True)
    skip_word: Mapped[Optional[str]] = mapped_column(
        String(100), doc=&quot;跳过词,用 , 分隔&quot;, nullable=True)
    add_text: Mapped[Optional[str]] = mapped_column(
        String(100), doc=&quot;跳过语,用 , 分隔&quot;, nullable=True)
</code></pre>
<h3 id="default-timestamp"><a class="header" href="#default-timestamp">Default timestamp</a></h3>
<p><a href="https://stackoverflow.com/questions/13370317/sqlalchemy-default-datetime">python - SQLAlchemy default DateTime - Stack Overflow</a></p>
<p>使用 <code>server_default</code> 而不是 <code>default</code> ，因此值将由数据库本身处理。</p>
<pre><code class="language-python">create_at: Mapped[datetime] = mapped_column(
	server_default=func.now(), default=None, nullable=False
)
</code></pre>
<h3 id="optimize"><a class="header" href="#optimize">Optimize</a></h3>
<p>数据库连接方面，可以避免出现 <code>sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (2013, 'Lost connection to MySQL server during query')</code> 的错误，reference: <a href="https://www.cnblogs.com/goldsunshine/p/17304427.html">sqlalchemy 报错 Lost connection to MySQL server during query 解决 - 金色旭光 - 博客园</a></p>
<pre><code class="language-python">engine = create_async_engine(DB_URL, pool_pre_ping=True, pool_recycle=600)
</code></pre>
<h3 id="relationship-延迟加载"><a class="header" href="#relationship-延迟加载"><code>relationship</code> 延迟加载</a></h3>
<pre><code class="language-python">class User(Base):
    __tablename__ = 'user'
    __table_args__ = {'comment': '转载用户表'}

    id: Mapped[str] = mapped_column(
        String(20), primary_key=True, comment=&quot;用户 ID&quot;)
        
	# lazy='subquery'
    configs: Mapped[List[&quot;TGForwardConfig&quot;]] = relationship(
        'TGForwardConfig', backref='user', lazy='subquery')
    
    reg_at: Mapped[datetime] = mapped_column(
        nullable=False, server_default=func.now(), comment='注册时间'
    )

    auth_time: Mapped[datetime] = mapped_column(
        default=lambda: datetime.now() + timedelta(days=7), nullable=True, comment='授权时间')

    def __repr__(self):
        return f'&lt;User(user_id={self.id}, reg_at={self.reg_at}, auth_time={self.auth_time})&gt;'
</code></pre>
<h3 id="databaseurl-数据库-url"><a class="header" href="#databaseurl-数据库-url">DatabaseURL 数据库 URL</a></h3>
<pre><code class="language-python"># SQLTIE3 sqlite+aiosqlite:///database.db  # 数据库文件名为 database.db 不存在的新建一个
# 异步 mysql+aiomysql://user:password@host:port/dbname
DB_URL = os.environ.get(&quot;DB_URL&quot;) or &quot;mysql+aiomysql://root:123456@localhost/tgforward?charset=utf8mb4&quot;
</code></pre>
<h2 id="alembic-英-əlembɪk-蒸馏器-sqlalchemy-数据库迁移"><a class="header" href="#alembic-英-əlembɪk-蒸馏器-sqlalchemy-数据库迁移">Alembic [英 /ə'lembɪk/ 蒸馏器] sqlalchemy 数据库迁移</a></h2>
<p>reference: </p>
<ol>
<li><a href="https://testdriven.io/blog/fastapi-sqlmodel/">FastAPI with Async SQLAlchemy, SQLModel, and Alembic | TestDriven.io</a></li>
<li>using asyncio with alembic（异步支持）： <a href="https://alembic.sqlalchemy.org/en/latest/cookbook.html#using-asyncio-with-alembic">Cookbook — Alembic 1.12.0 documentation</a></li>
<li>官方文档: <a href="https://alembic.sqlalchemy.org/en/latest/index.html">https://alembic.sqlalchemy.org/en/latest/index.html</a></li>
<li>相关项目: <a href="https://github.com/python-gino/gino">https://github.com/python-gino/gino</a> - <a href="https://www.bookstack.cn/read/gino-1.0-zh/3d56d5fe80ab5932.md">文档</a></li>
</ol>
<p>alembic [英 /ə'lembɪk/] 是 sqlalchemy 的作者开发的。用来做 OMR 模型与数据库的迁移与映射。<code>alembic</code> 使用方式跟 <code>git</code> 有点了类似，表现在两个方面，第一个，<code>alembic</code> 的所有命令都是以 <code>alembic</code> 开头；第二，<code>alembic</code> 的迁移文件也是通过版本进行控制的。首先，通过 <code>pip install alembic</code> 进行安装。以下将解释 <code>alembic</code> 的用法：</p>
<h3 id="初始化-alembic-仓库"><a class="header" href="#初始化-alembic-仓库">初始化 alembic 仓库</a></h3>
<p>在终端中，<code>cd</code> 到你的项目目录中，然后执行命令 <code>alembic init alembic</code>，创建一个名叫 <code>alembic</code> 的仓库。</p>
<h3 id="创建模型类"><a class="header" href="#创建模型类">创建模型类</a></h3>
<p>创建一个 <code>models.py</code> 模块，然后在里面定义你的模型类，示例代码如下：</p>
<pre><code class="language-python">import asyncio
from typing import List, Dict, Optional, Mapping, Type, TypeVar, Tuple
import typing
from typing_extensions import Annotated
from datetime import datetime, timedelta

# sqlalchemy type
import sqlalchemy.orm
from sqlalchemy import (
    ForeignKey,
    func,
    select,
    update,
    String,
    DateTime,
    Integer,
    Float,
    Boolean,
)

# sqlalchemy asynchronous support
from sqlalchemy.ext.asyncio import (
    AsyncAttrs,
    async_sessionmaker,
    AsyncSession,
    create_async_engine,
)

# sqlalchemy ORM
from sqlalchemy.orm import (
    DeclarativeBase,
    Mapped,
    mapped_column,
    relationship,
)

import inspect

from .string_template import StringTemplate, CustomParam, getBeijingTime

IDPK = Annotated[
    int,
    mapped_column(primary_key=True, autoincrement=True, comment=&quot;ID主键&quot;),
]


class Base(AsyncAttrs, DeclarativeBase):
    &quot;&quot;&quot;ORM 基类 | 详见[1]、[3]&quot;&quot;&quot;

    __table_args__ = {
        &quot;mysql_engine&quot;: &quot;InnoDB&quot;,  # MySQL引擎
        &quot;mysql_charset&quot;: &quot;utf8mb4&quot;,  # 设置表的字符集
        &quot;mysql_collate&quot;: &quot;utf8mb4_general_ci&quot;,  # 设置表的校对集
    }

</code></pre>
<h3 id="设置数据库连接"><a class="header" href="#设置数据库连接">设置数据库连接</a></h3>
<p>在 <a href="https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file" title="alembic.ini">alembic.ini</a> 中设置数据库的连接，<code>sqlalchemy.url = driver://user:pass@localhost/dbname</code>，比如以 mysql 数据库为例，则配置后的代码为：</p>
<p><code>sqlalchemy.url = mysql+mysqldb://root:root@localhost/alembic_demo?charset=utf8</code></p>
<h3 id="设置-target_metadata"><a class="header" href="#设置-target_metadata">设置 target_metadata</a></h3>
<p>为了使用模型类更新数据库，需要在 <code>env.py</code> 文件中设置 <a href="https://alembic.sqlalchemy.org/en/latest/ops.html?highlight=target_metadata#alembic.operations.Operations.f" title="target_metadata">target_metadata</a>，默认为 <code>target_metadata=None</code>。使用 <code>sys</code> 模块把当前项目的路径导入到 <code>path</code> 中：</p>
<pre><code class="language-python"># add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
from app.database.model import Base
target_metadata = Base.metadata
</code></pre>
<h3 id="自动生成迁移文件"><a class="header" href="#自动生成迁移文件">自动生成迁移文件</a></h3>
<p>使用 <code>alembic revision --autogenerate -m &quot;message&quot;</code> 将当前模型中的状态生成迁移文件。</p>
<p>异步 Base 支持：</p>
<pre><code class="language-shell">alembic init -t async alembic
</code></pre>
<h3 id="更新数据库"><a class="header" href="#更新数据库">更新数据库</a></h3>
<p>使用 <code>alembic upgrade head</code> 将刚刚生成的迁移文件，真正映射到数据库中。同理，如果要降级，那么使用 <code>alembic downgrade head</code>。</p>
<h3 id="命令和参数解释"><a class="header" href="#命令和参数解释">命令和参数解释</a></h3>
<ol>
<li><code>init</code>：创建一个 alembic 仓库。</li>
<li><code>revision</code>：创建一个新的版本文件。</li>
<li><code>–autogenerate</code>：自动将当前模型的修改，生成迁移脚本。</li>
<li><code>-m</code>：本次迁移做了哪些修改，用户可以指定这个参数，方便回顾。</li>
<li><code>upgrade</code>：将指定版本的迁移文件映射到数据库中，会执行版本文件中的 upgrade 函数。如果有多个迁移脚本没有被映射到数据库中，那么会执行多个迁移脚本。</li>
<li><code>[head]</code>：代表最新的迁移脚本的版本号。</li>
<li><code>downgrade</code>：会执行指定版本的迁移文件中的 downgrade 函数。</li>
<li><code>heads</code>：展示 head 指向的脚本文件版本号。</li>
<li><code>history</code>：列出所有的迁移版本及其信息。</li>
<li><code>current</code>：展示当前数据库中的版本号。</li>
</ol>
<p>另外，在你第一次执行 <code>upgrade</code> 的时候，就会在数据库中创建一个名叫 <code>alembic_version</code> 表，这个表只会有一条数据，记录当前数据库映射的是哪个版本的迁移文件。</p>
<h3 id="经典错误"><a class="header" href="#经典错误">经典错误</a></h3>
<div class="table-wrapper"><table><thead><tr><th>错误描述</th><th>原因</th><th>解决办法</th></tr></thead><tbody>
<tr><td><code>FAILED: Target database is not up to date.</code></td><td>主要是 <code>heads</code> 和 <code>current</code> 不相同。<code>current</code> 落后于 heads 的版本。</td><td>将 <code>current</code> 移动到 <code>head</code> 上。<code>alembic upgrade head</code></td></tr>
<tr><td><code>FAILED: Can't locate revision identified by '77525ee61b5b'</code></td><td>数据库中存的版本号不在迁移脚本文件中</td><td>删除数据库的 <code>alembic_version</code> 表中的数据，重新执行 <code>alembic upgrade head</code></td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../博客文章/_posts/Python/Python-Generator-Iterator-decorater.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../博客文章/_posts/Python/Python-Tkinter-GUI.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../博客文章/_posts/Python/Python-Generator-Iterator-decorater.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../博客文章/_posts/Python/Python-Tkinter-GUI.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
